name: V2EXæ¯æ—¥ç­¾åˆ°

# å®šæ—¶æ‰§è¡Œ & æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: "17 23 * * *" # æ¯å¤© 23:17 UTCï¼ˆåŒ—äº¬æ—¶é—´ 07:17ï¼‰
  workflow_dispatch: # å¯æ‰‹åŠ¨è§¦å‘

jobs:
  v2ex_sign:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
      V2EX_COOKIE: ${{ secrets.V2EX_COOKIE }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          sparse-checkout: |
            v2ex_sign

      - name: âœ… æ£€æŸ¥ç¯å¢ƒå˜é‡
        run: |
          for var in V2EX_COOKIE TELEGRAM_BOT_TOKEN TELEGRAM_CHAT_ID; do
            if [ -z "${!var}" ]; then
              echo "âŒ $var æœªè®¾ç½®æˆ–è€…ä¸ºç©º. è¯·åœ¨ GitHub Secrets ä¸­é…ç½®."
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰ç¯å¢ƒå˜é‡å·²é…ç½®"

      - name: ç¼“å­˜
        uses: actions/cache@v5
        with:
          path: |
            v2ex_sign/target/release/v2ex_sign
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ç¼–è¯‘
        working-directory: v2ex_sign
        run: |
          if [ ! -f "./target/release/v2ex_sign" ]; then
            echo "å¯æ‰§è¡Œæ–‡ä»¶ v2ex_sign ä¸å­˜åœ¨ï¼Œå¼€å§‹ç¼–è¯‘..."
            cargo build --release --locked
          else
            echo "å¯æ‰§è¡Œæ–‡ä»¶ v2ex_sign å·²å­˜åœ¨ï¼Œè·³è¿‡ç¼–è¯‘."
          fi

      - name: è¿è¡ŒV2EXç­¾åˆ°ä»»åŠ¡
        working-directory: v2ex_sign
        run: |
          echo "å®é™…å¼€å§‹è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          ./target/release/v2ex_sign
